#!/bin/bash

BACKUPS_DIR="/srv/backups"
BACKUP_DIR="${BACKUPS_DIR}/thunderbird"

# Stop Thunderbird before creating the backup
# TODO

# Create the final backup archive
echo "Creating backup archive..."
TIMESTAMP=$(date +'%Y-%m-%d_%Hh%M')
mkdir -p "${BACKUP_DIR}"
tar -czf "${BACKUP_DIR}/thunderbird-${TIMESTAMP}.tar.gz" -C "/home/baptiste" ".thunderbird"

# Ensure we never have more than 7 snapshots
echo "Keeping only last 7 backups..."
find "${BACKUPS_DIR}" -type f -name "thunderbird-*.tar.gz" -printf '%T+ %p\n' | sort | head -n -7 | awk '{print $2}' | xargs -I {} rm {}
